{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}LevelUp - Plataforma Educativa{% endblock %}</title>

  <!-- Bootstrap CSS (solo una vez) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Tus estilos -->
  <link rel="stylesheet" href="{% static 'LevelUp/css/style.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/navbar/navbar.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/navbar/navbar_docente.css' %}?v=7">
  <link rel="stylesheet" href="{% static 'LevelUp/css/navbar/navbar_estudiante.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/navbar/navbar_admin.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/footer.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/footer.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/global.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/login.css' %}?v=6">
  <link rel="stylesheet" href="{% static 'LevelUp/css/home.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/home_estudiante.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/home_docente.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/Ranking/ranking.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/games.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/register/register.css' %}">
  <link rel="stylesheet" href="{% static 'LevelUp/css/recuperar_contraseÃ±a/recuperar.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/error/404.css' %}?v=1">
  <link rel="stylesheet" href="{% static 'LevelUp/css/game_builder.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/gamificacion.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/rangos/rangos.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/estudiante_resultados.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/actividad_form.css' %}?v=5">
  <link rel="stylesheet" href="{% static 'LevelUp/css/portal_docente.css' %}?v=5">
  
  <!-- Fuentes / Ã­conos -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Merienda:wght@300..900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Henny+Penny&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Lobster+Two:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">

  {% block extra_head %}{% endblock %}
</head>


<body class="{% block body_class %}{% if request.user.is_authenticated %}{% if request.user.rol|default_if_none:''|lower == 'docente' or request.user.es_docente %}with-docente-navbar{% elif request.user.rol|default_if_none:''|lower == 'estudiante' or request.user.es_estudiante %}with-estudiante-navbar{% endif %}{% endif %}{% endblock %}">
  {% block navbar %}
  {% if request.user.is_authenticated %}

  {# === ESTUDIANTE === #}
  {% if request.user.rol|default_if_none:''|lower == 'estudiante' or request.user.es_estudiante %}
    {% include "LevelUp/partials/navbar_estudiante.html" %}

  {# === DOCENTE === #}
  {% elif request.user.rol|default_if_none:''|lower == 'docente' or request.user.es_docente %}
    {% include "LevelUp/partials/navbar_docente.html" %}

  {# === ADMIN / OTROS ROLES -> NAVBAR GENERAL === #}
  {% else %}
    {% include "LevelUp/partials/navbar.html" %}
  {% endif %}

  {% else %}
  {# Usuario no autenticado: navbar general #}
    {% include "LevelUp/partials/navbar.html" %}
  {% endif %}
  {% endblock %}

  {% block content %}{% endblock %}

  {# ========== TOAST GLOBAL DE RECOMPENSAS ========== #}
  {% if nuevas_recompensas %}
  <div id="reward-toast" class="reward-toast">
    <div class="reward-toast-inner">
      <div class="reward-toast-icon">ðŸŽ‰</div>
      <div class="reward-toast-text">
        <div class="reward-toast-title">Â¡Nuevo logro desbloqueado!</div>
        <div class="reward-toast-body">
          {% for nr in nuevas_recompensas %}
            <div class="reward-toast-item">
              <strong>{{ nr.recompensa.nombre }}</strong><br>
              {% if nr.recompensa.descripcion %}
                <small>{{ nr.recompensa.descripcion }}</small>
              {% else %}
                <small>{{ nr.recompensa.condicion_texto }}</small>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
      <button type="button"
              class="reward-toast-close"
              aria-label="Cerrar"
              onclick="document.getElementById('reward-toast').style.display='none';">
        âœ•
      </button>
    </div>
  </div>
  {% endif %}
  {# ========== FIN TOAST GLOBAL DE RECOMPENSAS ========== #}

  {% block footer %}
  {% if request.user.is_authenticated %}
    {% with rol=request.user.rol|default_if_none:''|lower url_name=request.resolver_match.url_name %}
      {% if rol == 'estudiante' %}
        {# Estudiante: sin footer #}
      {% elif rol == 'docente' and url_name == 'portal_docente' %}
        {# Portal del docente: sin footer #}
      {% else %}
        {# Otras vistas: con footer #}
        {% include "LevelUp/partials/footer.html" %}
      {% endif %}
    {% endwith %}
  {% else %}
    {# PÃºblico/no autenticado: footer pÃºblico #}
    {% include "LevelUp/partials/footer.html" %}
  {% endif %}
  {% endblock %}

  {% block extra_js %}
  <!-- Bootstrap JS bundle (con Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Tus scripts, despuÃ©s del bundle -->
  <script src="{% static 'LevelUp/js/script.js' %}?v=5"></script>
  <script src="{% static 'LevelUp/js/partials/navbar.js' %}?v=5"></script>
  
  
  {# Limpieza de storage al estar deslogueado (por ejemplo, tras logout) #}
  {% if not request.user.is_authenticated %}
  <script>
    try {
      localStorage.clear();
      sessionStorage.clear();
    } catch (e) {
      console.warn("Error limpiando storage:", e);
    }
  </script>
  {% endif %}
  {% endblock %}

</body>

</html>
