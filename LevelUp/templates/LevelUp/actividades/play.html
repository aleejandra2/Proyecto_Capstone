{% extends "LevelUp/base.html" %}
{% load static %}
{% block title %}{{ actividad.titulo }}{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-lg-10">

      <!-- Header de la actividad -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between">
            <div>
              <h1 class="h4 m-0">{{ actividad.titulo }}</h1>
              <p class="text-muted mb-0">{{ actividad.descripcion|default:"" }}</p>
            </div>
            <div class="text-end">
              <div class="badge bg-primary">Intento {{ intento_actual }} / {{ intentos_max }}</div>
              <div class="small text-muted mt-1">XP disponible: {{ xp_total }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Progreso general -->
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex align-items-center gap-3">
            <div class="flex-grow-1">
              <div class="progress" style="height: 20px;">
                <div class="progress-bar bg-success" role="progressbar" id="progressBar" style="width: 0%"
                  aria-valuenow="0" aria-valuemin="0" aria-valuemax="{{ total_items }}">
                  <span id="progressText">0 / {{ total_items }}</span>
                </div>
              </div>
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm" id="btnFinalizar">
              Finalizar intento
            </button>
          </div>
        </div>
      </div>

      <!-- √çtems del quiz -->
      <div id="items-wrapper">
        {% for item in items %}
        <div class="card mb-4 item-card" data-item-id="{{ item.id }}" data-item-tipo="{{ item.tipo }}">
          <div class="card-body">
            <div class="d-flex align-items-start justify-content-between mb-3">
              <div>
                <h3 class="h6 m-0">√çtem {{ forloop.counter }} de {{ total_items }}</h3>
                {% if item.enunciado %}
                <p class="text-muted mb-0 mt-1">{{ item.enunciado }}</p>
                {% endif %}
              </div>
              <span class="badge bg-info">{{ item.puntaje }} pts</span>
            </div>

            <!-- üîç DEBUG: Mostrar datos recibidos -->
            <div class="alert alert-info small mb-3" style="font-family: monospace;">
              <strong>üîç DEBUG √çtem {{ forloop.counter }}:</strong><br>
              ‚Ä¢ ID: {{ item.id }}<br>
              ‚Ä¢ Tipo: {{ item.tipo }}<br>
              ‚Ä¢ Kind: {{ item.datos.kind }}<br>
              ‚Ä¢ Tiene questions: {{ item.datos.questions|length|default:"0" }}<br>
              ‚Ä¢ Tiene trivia: {{ item.datos.trivia|length|default:"0" }}<br>
              ‚Ä¢ Tiene pairs: {{ item.datos.pairs|length|default:"0" }}<br>
              <details>
                <summary>Ver JSON completo</summary>
                <pre
                  style="max-height: 200px; overflow: auto; background: white; padding: 8px; margin-top: 8px;">{{ item.datos_json }}</pre>
              </details>
            </div>

            <!-- Host para el minijuego -->
            <div class="game-host" data-kind="{{ item.datos.kind }}" id="item-host-{{ item.id }}"
              data-config-id="item-config-json-{{ item.id }}" data-item-index="{{ forloop.counter }}">
              <!-- El juego se renderizar√° aqu√≠ -->
            </div>

            <!-- Datos JSON en script oculto -->
            <script type="application/json" id="item-config-json-{{ item.id }}">
{{ item.datos_json|safe }}
            </script>

            <!-- Estado de completado -->
            <div class="mt-3 text-center item-status" style="display:none;">
              <span class="badge bg-success">‚úì Completado</span>
            </div>
          </div>
        </div>
        {% empty %}
        <div class="alert alert-warning">
          <strong>‚ö†Ô∏è No hay √≠tems en esta actividad</strong>
        </div>
        {% endfor %}
      </div>

      <!-- Bot√≥n final -->
      <div class="text-center mb-4">
        <button type="button" class="btn btn-primary btn-lg" id="btnSubmit" style="display:none;">
          Enviar y ver resultados
        </button>
      </div>

    </div>
  </div>
</div>

<!-- Modal de confirmaci√≥n -->
<div class="modal fade" id="confirmModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirmar env√≠o</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>¬øEst√°s seguro de enviar el intento?</p>
        <p class="text-muted small">Has completado <strong id="completadosCount">0</strong> de {{ total_items }} √≠tems.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btnConfirmSubmit">Enviar</button>
      </div>
    </div>
  </div>
</div>

<!-- Scripts de los minijuegos -->
<link rel="stylesheet" href="{% static 'LevelUp/css/game_builder.css' %}">

<!-- Variables de configuraci√≥n -->
<script id="play-config" type="application/json">
{
  "actividadId": {{ actividad.id }},
  "submissionId": {{ submission.id }},
  "totalItems": {{ total_items }}
}
</script>

<!-- üîç DEBUG: Log inicial -->
<script>
  console.group('üéØ PLAY.HTML - Inicializaci√≥n');
  console.log('üìä Configuraci√≥n de la p√°gina:');
  const playConfig = JSON.parse(document.getElementById('play-config').textContent);
  console.log('  ‚Ä¢ Actividad ID:', playConfig.actividadId);
  console.log('  ‚Ä¢ Submission ID:', playConfig.submissionId);
  console.log('  ‚Ä¢ Total √≠tems:', playConfig.totalItems);

  console.log('\nüì¶ √çtems encontrados en el DOM:');
  document.querySelectorAll('.game-host').forEach((host, idx) => {
    const configId = host.dataset.configId;
    const kind = host.dataset.kind;
    const configEl = document.getElementById(configId);

    console.group(`√çtem ${idx + 1}`);
    console.log('  ‚Ä¢ Kind:', kind);
    console.log('  ‚Ä¢ Config ID:', configId);
    console.log('  ‚Ä¢ Config element existe:', !!configEl);

    if (configEl) {
      try {
        const data = JSON.parse(configEl.textContent);
        console.log('  ‚Ä¢ Datos parseados:', data);
        console.log('  ‚Ä¢ Tiene questions:', Array.isArray(data.questions) ? data.questions.length : 'NO');
        console.log('  ‚Ä¢ Tiene trivia:', Array.isArray(data.trivia) ? data.trivia.length : 'NO');
        console.log('  ‚Ä¢ Tiene pairs:', Array.isArray(data.pairs) ? data.pairs.length : 'NO');
      } catch (err) {
        console.error('  ‚Ä¢ Error parseando JSON:', err);
        console.log('  ‚Ä¢ Contenido:', configEl.textContent.substring(0, 100));
      }
    }
    console.groupEnd();
  });
  console.groupEnd();
</script>

<script type="module">
  import '{% static "LevelUp/js/games/loader.js" %}';

  // Cargar configuraci√≥n
  const config = JSON.parse(document.getElementById('play-config').textContent);
  const ACTIVIDAD_ID = config.actividadId;
  const SUBMISSION_ID = config.submissionId;
  const total = config.totalItems;
  let completados = 0;

  console.log('üéÆ Script de juego iniciado');

  // Escuchar eventos de completado de cada juego
  document.querySelectorAll('.game-host').forEach((host, idx) => {
    console.log(`üîó Configurando observer para host ${idx + 1}`);

    const itemCard = host.closest('.item-card');
    const itemId = itemCard.dataset.itemId;

    // Observer para detectar cuando el juego marca gameComplete
    const observer = new MutationObserver((mutations) => {
      mutations.forEach(mutation => {
        if (mutation.attributeName === 'data-game-complete') {
          console.log(`üéØ Host ${idx + 1} cambi√≥ data-game-complete a:`, host.dataset.gameComplete);
        }
      });

      if (host.dataset.gameComplete === 'true' && !itemCard.dataset.completed) {
        console.log(`‚úÖ √çtem ${idx + 1} (ID: ${itemId}) completado`);

        itemCard.dataset.completed = 'true';
        completados++;
        updateProgress();
        saveItemResult(itemId, host);
        itemCard.querySelector('.item-status').style.display = '';
      }
    });

    observer.observe(host, { attributes: true, attributeFilter: ['data-game-complete'] });
  });

  function updateProgress() {
    const pct = Math.round((completados / total) * 100);
    const bar = document.getElementById('progressBar');
    const text = document.getElementById('progressText');
    bar.style.width = pct + '%';
    bar.setAttribute('aria-valuenow', completados);
    text.textContent = `${completados} / ${total}`;

    document.getElementById('completadosCount').textContent = completados;

    // Mostrar bot√≥n de env√≠o cuando todos est√©n completos
    if (completados >= total) {
      console.log('üéâ Todos los √≠tems completados');
      document.getElementById('btnSubmit').style.display = '';
    }
  }

  async function saveItemResult(itemId, host) {
    console.log(`üíæ Guardando resultado del √≠tem ${itemId}`);

    const payload = {
      completado: true,
      score: parseFloat(host.dataset.gameScore || '1'),
      kind: host.dataset.kind || 'game',
      meta: {
        correctas: parseInt(host.dataset.gameCorrect || '0'),
        total: parseInt(host.dataset.gameTotal || '0')
      }
    };

    console.log('  ‚Ä¢ Payload:', payload);

    try {
      const csrftoken = document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
      const res = await fetch(`/api/actividades/${ACTIVIDAD_ID}/answer/${itemId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ payload })
      });

      if (!res.ok) {
        console.error('‚ùå Error guardando resultado del √≠tem', itemId);
        console.error('  ‚Ä¢ Status:', res.status);
        console.error('  ‚Ä¢ Response:', await res.text());
      } else {
        const data = await res.json();
        console.log('‚úÖ Resultado guardado:', data);
      }
    } catch (err) {
      console.error('‚ùå Error de red:', err);
    }
  }

  // Bot√≥n finalizar
  document.getElementById('btnFinalizar').addEventListener('click', () => {
    console.log('üèÅ Bot√≥n finalizar clickeado');
    if (completados < total) {
      const conf = confirm(`Solo has completado ${completados} de ${total} √≠tems. ¬øFinalizar de todas formas?`);
      if (!conf) {
        console.log('  ‚Ä¢ Cancelado por el usuario');
        return;
      }
    }
    showModal();
  });

  // Bot√≥n enviar (solo aparece cuando todos est√°n completos)
  document.getElementById('btnSubmit').addEventListener('click', () => {
    console.log('üì§ Bot√≥n enviar clickeado');
    showModal();
  });

  function showModal() {
    console.log('üìã Mostrando modal de confirmaci√≥n');
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
  }

  document.getElementById('btnConfirmSubmit').addEventListener('click', async () => {
    console.log('‚úÖ Confirmando env√≠o final...');

    // Marcar submission como finalizado
    try {
      const csrftoken = document.cookie.match(/csrftoken=([^;]+)/)?.[1] || '';
      const res = await fetch(`/api/actividades/${ACTIVIDAD_ID}/answer/0/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          payload: {
            completado: true,
            finalizar: true,
            score: completados / total,
            meta: { completados, total }
          }
        })
      });

      if (res.ok) {
        console.log('‚úÖ Submission finalizado correctamente');
      } else {
        console.error('‚ùå Error finalizando:', res.status);
      }
    } catch (err) {
      console.error('‚ùå Error finalizando:', err);
    }

    // Redirigir a resultados
    console.log('üîÑ Redirigiendo a resultados...');
    window.location.href = `/actividades/estudiante/${ACTIVIDAD_ID}/resultado/`;
  });
</script>

{% endblock %}