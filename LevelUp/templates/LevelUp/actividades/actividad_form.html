{% extends "LevelUp/base.html" %}
{% load static %}
{% block title %}{% if editar %}Editar{% else %}Nueva{% endif %} actividad{% endblock %}

{% block content %}
<div class="container py-3">

  {# ======== ALERTA GENERAL DE ERRORES (server) ======== #}
  {% if form.errors or formset.non_form_errors %}
  <div class="alert alert-danger mb-3">
    <strong>‚ö†Ô∏è Hay errores en el formulario:</strong>
    <ul class="mb-0 mt-2">
      {% for field in form %}
      {% if field.errors %}
      <li><strong>{{ field.label }}:</strong> {{ field.errors|striptags }}</li>
      {% endif %}
      {% endfor %}
      {% if formset.non_form_errors %}
      {% for e in formset.non_form_errors %}
      <li>{{ e }}</li>
      {% endfor %}
      {% endif %}
    </ul>
  </div>
  {% endif %}

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0">{% if editar %}‚úèÔ∏è Editar{% else %}‚ûï Nueva{% endif %} actividad</h1>
    <a href="{% url 'docente_lista' %}" class="btn btn-outline-secondary btn-sm">‚Üê Volver</a>
  </div>

  {# NOVALIDATE: desactiva validaci√≥n nativa del navegador para manejar tabs sin bloqueo #}
  <form method="post" enctype="multipart/form-data" id="actividad-form" novalidate>
    {% csrf_token %}
    {% if editar %}<input type="hidden" name="editar" value="1">{% endif %}

    <ul class="nav nav-tabs mb-3" id="actividadTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-info" data-bs-toggle="tab" data-bs-target="#panel-info" type="button">
          üìù Informaci√≥n b√°sica
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-contenido" data-bs-toggle="tab" data-bs-target="#panel-contenido"
          type="button">
          üéÆ Contenido
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-asignar" data-bs-toggle="tab" data-bs-target="#panel-asignar" type="button">
          üë• Asignar estudiantes
        </button>
      </li>
    </ul>

    <div class="tab-content" id="actividadTabContent">

      {# ================= TAB 1: INFORMACI√ìN B√ÅSICA ================= #}
      <div class="tab-pane fade show active" id="panel-info" role="tabpanel">
        <div class="card p-4">

          <div class="row g-3 mb-3">
            <div class="col-12 col-md-8">
              <label class="form-label fw-bold">T√≠tulo de la actividad <span class="text-danger">*</span>
                <span class="text-muted small">(obligatorio)</span></label>
              {{ form.titulo }}
              <div class="invalid-feedback d-block d-none" data-client-error-for="id_titulo"></div>
              {% if form.titulo.errors %}<div class="invalid-feedback d-block">{{ form.titulo.errors|striptags }}</div>
              {% endif %}
              <div class="form-text">Un nombre claro y descriptivo</div>
            </div>

            <div class="col-6 col-md-2">
              <label class="form-label fw-bold">Tipo <span class="text-danger">*</span>
                <span class="text-muted small">(obligatorio)</span></label>
              {{ form.tipo }}
              <div class="invalid-feedback d-block d-none" data-client-error-for="id_tipo"></div>
              {% if form.tipo.errors %}<div class="invalid-feedback d-block">{{ form.tipo.errors|striptags }}</div>{% endif %}
            </div>

            <div class="col-6 col-md-2">
              <label class="form-label fw-bold">Dificultad <span class="text-muted small">(opcional)</span></label>
              {{ form.dificultad }}
              {% if form.dificultad.errors %}<div class="invalid-feedback d-block">{{ form.dificultad.errors|striptags }}</div>{% endif %}
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold">Descripci√≥n <span class="text-muted small">(opcional)</span></label>
            {{ form.descripcion }}
            {% if form.descripcion.errors %}<div class="invalid-feedback d-block">{{ form.descripcion.errors|striptags }}</div>{% endif %}
            <div class="form-text">Instrucciones para el estudiante</div>
          </div>

          <div class="row g-3 mb-3">
          
            <!-- Columna izquierda: Intentos + Ilimitado -->
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold d-block">üîÑ Intentos
                <span class="text-muted small">(obligatorio si no es ilimitado)</span>
              </label>
          
              <div class="input-group">
                {{ form.intentos_max }}
                <span class="input-group-text">m√°x.</span>
              </div>
              <div class="form-text">1‚Äì1000 si no es ilimitado</div>
              <div class="invalid-feedback d-block d-none" id="err_intentos_max"></div>
              {% if form.intentos_max.errors %}
              <div class="invalid-feedback d-block">
                {{ form.intentos_max.errors|striptags }}
              </div>
              {% endif %}
          
              <div class="form-check mt-2">
                {{ form.intentos_ilimitados }}
                <label class="form-check-label ms-1" for="id_intentos_ilimitados">Ilimitado</label>
              </div>
              {% if form.intentos_ilimitados.errors %}
              <div class="invalid-feedback d-block">
                {{ form.intentos_ilimitados.errors|striptags }}
              </div>
              {% endif %}
            </div>
          
            <!-- Columna derecha: Fecha cierre + Publicada -->
            <div class="col-12 col-md-6">
              <label class="form-label fw-bold">üìÖ Fecha cierre
                <span class="text-muted small">(opcional)</span>
              </label>
              {{ form.fecha_cierre }}
              {% if form.fecha_cierre.errors %}
              <div class="invalid-feedback d-block">
                {{ form.fecha_cierre.errors|striptags }}
              </div>
              {% endif %}
          
              <div class="form-check mt-2">
                {{ form.es_publicada }}
                <label class="form-check-label fw-bold ms-1">‚úÖ Publicada</label>
              </div>
            </div>
          
          </div>

          <div class="d-flex justify-content-end gap-2 mt-4">
            <button type="button" class="btn btn-primary btn-lg" onclick="nextTab()">Siguiente: Contenido ‚Üí</button>
          </div>
        </div>
      </div>

      {# ================= TAB 2: CONTENIDO (√çTEMS) ================= #}
      <div class="tab-pane fade" id="panel-contenido" role="tabpanel">
        <div class="card p-4">

          {% with act_tipo=form.instance.tipo %}
          <div id="items-formset" data-actividad-tipo="{{ act_tipo|default:'quiz' }}">

            <div class="alert alert-info">
              <strong>üí° Instrucciones:</strong>
              Configura los √≠tems de esta actividad.
              <div class="small text-muted mt-1">
                En cada √≠tem, el <strong>Enunciado</strong> es
                <span class="text-danger">obligatorio</span> si el √≠tem tiene contenido.
              </div>
            </div>

            {{ formset.management_form }}

            <div id="items-container">
              {% for f in formset.forms %}
              <div class="item-form card mb-4 shadow-sm"
                data-item-id="{% if f.instance.pk %}{{ f.instance.pk }}{% endif %}">
                <div class="card-header bg-light">
                  <div class="row g-2 align-items-center">
                    <div class="col-12 col-lg-8">
                      <div class="d-flex flex-wrap align-items-center gap-2">
                        <h6 class="mb-0 me-2">üéØ √çtem #{{ forloop.counter }}</h6>
                        <div class="flex-grow-1">
                          <label class="form-label small mb-1">Tipo de actividad
                            <span class="text-muted small">(obligatorio)</span></label>
                          {{ f.item_kind }}
                        </div>
                      </div>
                    </div>

                    <div class="col-12 col-lg-auto ms-auto text-end">
                      <button type="button" class="btn btn-outline-danger btn-sm btn-remove-card">üóë Eliminar</button>
                    </div>
                  </div>
                </div>

                <div class="card-body">
                  <div style="display:none">
                    {{ f.id }} {{ f.DELETE }} {{ f.puntaje }}
                  </div>

                  {% if f.non_field_errors %}
                  <div class="alert alert-danger small mb-2">{{ f.non_field_errors|striptags }}</div>
                  {% endif %}

                  <div class="mb-3">
                    <label class="form-label fw-bold">Enunciado / Consigna <span class="text-danger">*</span>
                      <span class="text-muted small">(obligatorio si el √≠tem tiene contenido)</span></label>
                    {{ f.enunciado }}
                    <div class="invalid-feedback d-block d-none" data-client-error></div>
                    {% if f.enunciado.errors %}<div class="invalid-feedback d-block">{{ f.enunciado.errors|striptags }}
                    </div>{% endif %}
                    <div class="form-text">Instrucci√≥n que ver√° el estudiante</div>
                  </div>

                  {# Tiempo oculto, se mantiene por compatibilidad #}
                  <div style="display:none">
                    {{ f.game_time_limit }}
                    {% if f.game_time_limit.errors %}<div class="invalid-feedback d-block">{{ f.game_time_limit.errors|striptags }}</div>{% endif %}
                  </div>

                  <div class="row g-2 align-items-center mb-3">
                    <div class="col-12 text-end">
                      <span class="gb-counter badge bg-secondary">0 √≠tems</span>
                    </div>
                  </div>

                  <div class="gbuilder"></div>

                  <div style="display:none">
                    {{ f.game_pairs }}
                    {% if f.game_pairs.errors %}<div class="invalid-feedback d-block mt-2">{{ f.game_pairs.errors|striptags }}</div>{% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>

            <div class="text-center mt-4">
              <button id="btn-add-item" type="button" class="btn btn-outline-primary btn-lg">‚ûï Agregar √≠tem</button>
            </div>

            {# === plantilla de formulario vac√≠o para nuevos √≠tems === #}
            <template id="empty-form-template">
              <div class="item-form card mb-4 shadow-sm" data-prefix="__prefix__">
                <div class="card-header bg-light">
                  <div class="row g-2 align-items-center">
                    <div class="col-12 col-lg-8">
                      <div class="d-flex flex-wrap align-items-center gap-2">
                        <h6 class="mb-0">üéØ √çtem #</h6>
                        <div class="flex-grow-1">
                          <label class="form-label small mb-1">Tipo de actividad
                            <span class="text-muted small">(obligatorio)</span></label>
                          <select name="items-__prefix__-item_kind" class="form-select">
                            <option value="dragmatch" selected>Drag & Match</option>
                            <option value="memory">Memoria (pares)</option>
                            <option value="trivia">Trivia (opci√≥n m√∫ltiple)</option>
                            <option value="vf">Verdadero / Falso</option>
                            <option value="classify">Clasificar en categor√≠as</option>
                            <option value="cloze">Completar (cloze)</option>
                            <option value="ordering">Ordenar pasos</option>
                          </select>
                        </div>
                      </div>
                    </div>

                    <div class="col-12 col-lg-auto ms-auto text-end">
                      <button type="button" class="btn btn-outline-danger btn-sm btn-remove-card">üóë Eliminar</button>
                    </div>
                  </div>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label class="form-label fw-bold">Enunciado / Consigna <span class="text-danger">*</span>
                      <span class="text-muted small">(obligatorio si el √≠tem tiene contenido)</span></label>
                    <textarea name="items-__prefix__-enunciado" rows="2" class="form-control"
                      placeholder="Instrucci√≥n para el estudiante..."></textarea>
                    <div class="invalid-feedback d-block d-none" data-client-error></div>
                  </div>

                  {# Tiempo oculto #}
                  <div style="display:none">
                    <input type="number" name="items-__prefix__-game_time_limit" class="form-control" min="5">
                  </div>

                  <div class="row g-2 align-items-center mb-3">
                    <div class="col-12 text-end">
                      <span class="gb-counter badge bg-secondary">0 √≠tems</span>
                    </div>
                  </div>

                  <div class="gbuilder"></div>
                  <textarea name="items-__prefix__-game_pairs" style="display:none"></textarea>
                  <input type="hidden" name="items-__prefix__-puntaje" value="1">
                  <input type="hidden" name="items-__prefix__-id" value="">
                  <input type="hidden" name="items-__prefix__-DELETE" value="0">
                </div>
              </div>
            </template>

          </div>
          {% endwith %}

          <div class="d-flex justify-content-between gap-2 mt-4">
            <button type="button" class="btn btn-outline-secondary btn-lg" onclick="prevTab()">‚Üê Anterior</button>
            <button type="button" class="btn btn-primary btn-lg" onclick="nextTab()">Siguiente: Asignar ‚Üí</button>
          </div>
        </div>
      </div>

      {# ================= TAB 3: ASIGNACI√ìN ================= #}
      <div class="tab-pane fade" id="panel-asignar" role="tabpanel">
        <div class="card p-4">
          <div class="alert alert-info">
            <strong>üí° Asignaci√≥n de estudiantes</strong><br>
            Selecciona los cursos o estudiantes individuales que podr√°n acceder a esta actividad.
          </div>

          <div class="mb-4">
            <h6 class="fw-bold mb-3">üë• Asignar por curso completo</h6>
            <div class="row g-2">
              {% for curso in cursos %}
              <div class="col-6 col-md-4 col-lg-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="cursos" value="{{ curso.id }}"
                    id="curso_{{ curso.id }}" {% if curso.id in cursos_asignados %}checked{% endif %}>
                  <label class="form-check-label" for="curso_{{ curso.id }}">{{ curso }}</label>
                </div>
              </div>
              {% empty %}
              <div class="col-12">
                <p class="text-muted">No hay cursos disponibles</p>
              </div>
              {% endfor %}
            </div>
          </div>

          <hr>

          <div class="mb-4">
            <h6 class="fw-bold mb-3">üéØ Asignar estudiantes individuales</h6>

            <div class="mb-3">
              <input type="text" id="search-estudiantes" class="form-control"
                placeholder="üîç Buscar estudiante por nombre...">
            </div>

            <div id="estudiantes-list" class="row g-2" style="max-height: 400px; overflow-y: auto;">
              {% for est in estudiantes %}
              <div class="col-6 col-md-4 col-lg-3 estudiante-item"
                data-nombre="{{ est.usuario.first_name }} {{ est.usuario.last_name }}">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="alumnos" value="{{ est.usuario.id }}"
                    id="est_{{ est.usuario.id }}" {% if est.usuario.id in asignados_usuarios %}checked{% endif %}>
                  <label class="form-check-label" for="est_{{ est.usuario.id }}">{{ est.usuario.get_full_name }}</label>
                </div>
              </div>
              {% empty %}
              <div class="col-12">
                <p class="text-muted">No hay estudiantes disponibles</p>
              </div>
              {% endfor %}
            </div>
          </div>

          <div class="d-flex justify-content-between gap-2 mt-4">
            <button type="button" class="btn btn-outline-secondary btn-lg" onclick="prevTab()">‚Üê Anterior</button>
            <div class="d-flex gap-2">
              <button type="submit" name="accion" value="guardar" class="btn btn-success btn-lg">üíæ Guardar actividad</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </form>

</div>

<link rel="stylesheet" href="{% static 'LevelUp/css/game_builder.css' %}">
<link rel="stylesheet" href="{% static 'LevelUp/css/actividad_form.css' %}">
<script src="{% static 'LevelUp/js/actividades/game_builder_helper.js' %}"></script>
<script src="{% static 'LevelUp/js/actividades/actividad_formset.js' %}"></script>

<script>
  function nextTab() { const a = document.querySelector('.nav-link.active'); const n = a.closest('li').nextElementSibling?.querySelector('.nav-link'); if (n) n.click() }
  function prevTab() { const a = document.querySelector('.nav-link.active'); const p = a.closest('li').previousElementSibling?.querySelector('.nav-link'); if (p) p.click() }

  // Filtro en asignaci√≥n
  document.getElementById('search-estudiantes')?.addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('.estudiante-item').forEach(li => {
      li.style.display = (li.dataset.nombre.toLowerCase().includes(q) ? '' : 'none');
    });
  });

  // Abrir tab Asignar si viene flag desde la vista
  if ('{{ abrir_asignar }}' === 'True') document.getElementById('tab-asignar')?.click();

  // ======= VALIDACI√ìN CLIENTE =======
  (function () {
    const form = document.getElementById('actividad-form');
    if (!form) return;

    const cbIlimitado = document.getElementById('id_intentos_ilimitados');
    const inpMax = document.getElementById('id_intentos_max');
    const errMax = document.getElementById('err_intentos_max');

    function toggleIntentosUI() {
      const ilimit = cbIlimitado?.checked;
      if (!inpMax) return;
      if (ilimit) {
        inpMax.disabled = true;
        inpMax.required = false;
        inpMax.classList.remove('is-invalid');
        if (errMax) { errMax.textContent = ''; errMax.classList.add('d-none'); }
      } else {
        inpMax.disabled = false;
        inpMax.required = true;
      }
    }
    cbIlimitado?.addEventListener('change', toggleIntentosUI);
    toggleIntentosUI();

    function putError(input, msg) {
      input.classList.add('is-invalid');
      if (errMax && input === inpMax) { errMax.textContent = msg; errMax.classList.remove('d-none'); }
    }
    function clearError(input) {
      input.classList.remove('is-invalid');
      if (errMax && input === inpMax) { errMax.textContent = ''; errMax.classList.add('d-none'); }
    }

    form.addEventListener('input', e => { if (e.target === inpMax) clearError(inpMax); });
    form.addEventListener('change', e => { if (e.target === inpMax || e.target === cbIlimitado) clearError(inpMax); });

    form.addEventListener('submit', e => {
      let hasErrors = false, firstError = null;

      // T√≠tulo/tipo m√≠nimos
      const titulo = document.getElementById('id_titulo');
      const tipo = document.getElementById('id_tipo');
      if (titulo && !titulo.value.trim()) { hasErrors = true; firstError = firstError || titulo; }
      if (tipo && !tipo.value) { hasErrors = true; firstError = firstError || tipo; }

      // Intentos: si NO es ilimitado, exigir 1..1000
      if (!cbIlimitado?.checked && inpMax) {
        const v = String(inpMax.value || '').trim();
        const n = Number(v);
        if (!v || !Number.isInteger(n) || n < 1 || n > 1000) {
          hasErrors = true; firstError = firstError || inpMax;
          putError(inpMax, 'Debe ingresar un entero entre 1 y 1000 o marcar "Ilimitado".');
        }
      }

      // √çtems con contenido: enunciado obligatorio
      const contenidoTab = document.getElementById('tab-contenido');
      const panelContenido = document.getElementById('panel-contenido');
      const items = document.querySelectorAll('#items-container .item-form:not([data-deleted="1"])');
      items.forEach(card => {
        const enun = card.querySelector('[name$="-enunciado"]');
        const payload = card.querySelector('textarea[name$="-game_pairs"], textarea[name$="-datos"]');
        const enunVal = enun ? enun.value.trim() : '';
        const payVal = payload ? payload.value.trim() : '';
        const hasContent = !!(payVal || enunVal);

        if (hasContent) {
          if (enun && !enunVal) { hasErrors = true; firstError = firstError || enun; }
        }
      });

      if (hasErrors) {
        e.preventDefault();
        if (firstError && firstError.closest('#panel-contenido') && !panelContenido.classList.contains('show')) contenidoTab?.click();
        setTimeout(() => { firstError?.scrollIntoView({ behavior: 'smooth', block: 'center' }); firstError?.focus?.({ preventScroll: true }); }, 80);
      }
    });
  })();
</script>

{% endblock %}