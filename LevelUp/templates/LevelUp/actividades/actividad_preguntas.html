{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Editar Preguntas ¬∑ {{ actividad.titulo }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="{% static 'LevelUp/css/bootstrap.min.css' %}" rel="stylesheet">
  <style>
    .lv-wrap{max-width:1100px;margin:28px auto;padding:16px}
    .lv-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
    .pill{display:inline-block;padding:.2rem .6rem;border-radius:999px;background:#eef;border:1px solid #ccd;color:#334;margin-left:.5rem;font-size:.85rem}
    .card{border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    .form-mini{font-size:.9rem}
    .json-helper{font-size:.85rem;color:#556}
    .json-helper code{background:#f6f8fa;padding:.15rem .35rem;border-radius:6px}
    .item-row{border:1px solid #e9ecef;border-radius:12px;padding:12px;margin-bottom:10px;background:#fff}
    .item-actions{display:flex;gap:10px;align-items:center}
    .d-none{display:none}
    .text-mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
<div class="lv-wrap">
  <div class="lv-head">
    <div>
      <h1 class="h4 m-0">Editar preguntas ‚Äî <strong>{{ actividad.titulo }}</strong></h1>
      <div class="text-muted mt-1">
        Asignatura: {{ actividad.asignatura|default:"(sin asignatura)" }}
        <span class="pill">Dificultad actual: {{ actividad.get_dificultad_display }}</span>
        {% if actividad.es_publicada %}<span class="pill">Publicada</span>{% endif %}
      </div>
    </div>
    <div>
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'actividad_editar' actividad.pk %}">‚Ü© Volver a la actividad</a>
    </div>
  </div>

  <form method="post" enctype="multipart/form-data" class="form-mini">
    {% csrf_token %}

    <div class="card mb-3 p-3">
      <h2 class="h6">Propiedades generales</h2>
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label">Dificultad</label>
          {{ form.dificultad|add_class:"form-select" }}
        </div>
        <div class="col-md-3">
          <label class="form-label">XP total</label>
          {{ form.xp_total|add_class:"form-control" }}
        </div>
        <div class="col-md-3">
          <label class="form-label">Intentos m√°x.</label>
          {{ form.intentos_max|add_class:"form-control" }}
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <div class="form-check">
            {{ form.es_publicada|add_class:"form-check-input" }}
            <label class="form-check-label">Publicada</label>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Fecha cierre</label>
          {{ form.fecha_cierre|add_class:"form-control" }}
        </div>
      </div>
    </div>

    <div class="card p-3">
      <div class="d-flex align-items-center justify-content-between">
        <h2 class="h6 m-0">√çtems del minijuego (preguntas)</h2>
        <button type="button" id="btn-add" class="btn btn-primary btn-sm">+ A√±adir √≠tem</button>
      </div>

      {{ formset.management_form }}
      <div id="items-wrap" class="mt-3">
        {% for f in formset.forms %}
          <div class="item-row" data-form-index="{{ forloop.counter0 }}">
            <div class="mb-2">
              <label class="form-label">Enunciado (visible para el alumno)</label>
              {{ f.enunciado|add_class:"form-control" }}
            </div>
            <div class="row g-2">
              <div class="col-md-3">
                <label class="form-label">Puntaje</label>
                {{ f.puntaje|add_class:"form-control" }}
              </div>
              <div class="col-md-4">
                <label class="form-label">Tipo de juego</label>
                {{ f.game_kind|add_class:"form-select" }}
              </div>
              <div class="col-md-3">
                <label class="form-label">Tiempo l√≠mite (s)</label>
                {{ f.game_time_limit|add_class:"form-control" }}
              </div>
              <div class="col-md-2 d-flex align-items-end">
                <div class="form-check">
                  {{ f.DELETE }} <label class="form-check-label">Eliminar</label>
                </div>
              </div>
            </div>

            <div class="mt-2">
              <div class="json-helper">
                Contenido JSON del juego
                (<code>pairs</code>, <code>questions</code>, <code>categories</code>/<code>items</code>, etc.).<br>
                Ejemplos r√°pidos:
                <ul class="mb-1">
                  <li><b>Drag & Match</b>: <code>{"pairs":[["3√ó4","12"],["5√ó2","10"]]}</code></li>
                  <li><b>Trivia</b>: <code>{"questions":[{"q":"144 √∑ 12 = ?","opts":["10","12"],"ans":1}]}</code></li>
                  <li><b>Clasificar</b>: <code>{"categories":["Primo","Compuesto"],"items":[["2","Primo"],["9","Compuesto"]]}</code></li>
                </ul>
              </div>
              {{ f.game_pairs|add_class:"form-control text-mono" }}
            </div>

            {{ f.tipo }} <!-- hidden 'game' -->
          </div>
        {% empty %}
          <div class="alert alert-info">A√∫n no hay preguntas. Usa ‚ÄúA√±adir √≠tem‚Äù.</div>
        {% endfor %}
      </div>

      <!-- prototipo para JS (se usa para nuevos √≠tems) -->
      <template id="tpl-item">
        <div class="item-row" data-form-index="__prefix__">
          <div class="mb-2">
            <label class="form-label">Enunciado (visible para el alumno)</label>
            __enunciado__
          </div>
          <div class="row g-2">
            <div class="col-md-3">
              <label class="form-label">Puntaje</label>
              __puntaje__
            </div>
            <div class="col-md-4">
              <label class="form-label">Tipo de juego</label>
              __game_kind__
            </div>
            <div class="col-md-3">
              <label class="form-label">Tiempo l√≠mite (s)</label>
              __game_time_limit__
            </div>
            <div class="col-md-2 d-flex align-items-end">
              <div class="form-check">
                __delete__ <label class="form-check-label">Eliminar</label>
              </div>
            </div>
          </div>
          <div class="mt-2">
            <div class="json-helper">Contenido JSON del juego.</div>
            __game_pairs__
          </div>
          __tipo__
        </div>
      </template>

      <div class="mt-3 d-flex gap-2">
        <button class="btn btn-success" type="submit">üíæ Guardar cambios</button>
        <a class="btn btn-outline-secondary" href="{% url 'actividad_editar' actividad.pk %}">Cancelar</a>
      </div>
    </div>

  </form>
</div>

<script>
(function(){
  // add_class filter fallback si no usas django-widget-tweaks
  // (opcional; puedes ignorarlo si ya usas el filtro)
})();
</script>

<script>
  // ======= Din√°mica para a√±adir formularios del formset =======
  const btnAdd = document.getElementById('btn-add');
  const wrap   = document.getElementById('items-wrap');
  const total  = document.getElementById('{{ formset.management_form.prefix }}-TOTAL_FORMS');
  const tpl    = document.getElementById('tpl-item').innerHTML;

  // Generador de campos por √≠ndice, bas√°ndose en el primer form vac√≠o del formset
  const emptyPrefix = '{{ formset.prefix }}-__prefix__';
  const fieldHtml = (name) => {
    // construye el input como el formset vac√≠o est√°ndar
    const id = `${emptyPrefix}-${name}`;
    const nm = `${emptyPrefix}-${name}`;
    if (name === 'tipo') {
      return `<input type="hidden" name="${nm}" id="${id}" value="game">`;
    }
    if (name === 'enunciado') {
      return `<textarea name="${nm}" id="${id}" rows="2" class="form-control" placeholder="Describe qu√© debe hacer el alumno‚Ä¶"></textarea>`;
    }
    if (name === 'puntaje') {
      return `<input type="number" name="${nm}" id="${id}" class="form-control" min="0" value="10">`;
    }
    if (name === 'game_kind') {
      return `<select name="${nm}" id="${id}" class="form-select">
        <option value="dragmatch">Drag & Match</option>
        <option value="memory">Memoria (pares)</option>
        <option value="trivia">Trivia</option>
        <option value="vf">Verdadero / Falso</option>
        <option value="classify">Clasificar</option>
        <option value="cloze">Completar (cloze)</option>
        <option value="ordering">Ordenar pasos</option>
        <option value="labyrinth">Laberinto</option>
        <option value="shop">Tiendita</option>
      </select>`;
    }
    if (name === 'game_time_limit') {
      return `<input type="number" name="${nm}" id="${id}" class="form-control" min="5" max="3600" value="60">`;
    }
    if (name === 'game_pairs') {
      return `<textarea name="${nm}" id="${id}" rows="4" class="form-control text-mono">{}</textarea>`;
    }
    if (name === 'DELETE') {
      return `<input type="checkbox" name="${nm}" id="${id}">`;
    }
    return '';
  };

  btnAdd?.addEventListener('click', () => {
    const idx = parseInt(total.value, 10);
    let html = tpl
      .replaceAll('__enunciado__', fieldHtml('enunciado'))
      .replaceAll('__puntaje__', fieldHtml('puntaje'))
      .replaceAll('__game_kind__', fieldHtml('game_kind'))
      .replaceAll('__game_time_limit__', fieldHtml('game_time_limit'))
      .replaceAll('__delete__', fieldHtml('DELETE'))
      .replaceAll('__game_pairs__', fieldHtml('game_pairs'))
      .replaceAll('__tipo__', fieldHtml('tipo'));

    // reemplaza __prefix__ por √≠ndice real
    html = html.replaceAll('__prefix__', idx.toString());

    const div = document.createElement('div');
    div.innerHTML = html.trim();
    wrap.appendChild(div.firstElementChild);

    total.value = idx + 1;
  });
</script>
</body>
</html>
