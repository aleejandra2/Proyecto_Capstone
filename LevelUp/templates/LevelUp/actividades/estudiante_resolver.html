{% extends "LevelUp/base.html" %}
{% load static %}
{% block title %}{{ actividad.titulo }}{% endblock %}

{% block content %}
<div class="container py-3">

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} mb-3">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <div class="d-flex align-items-center justify-content-between mb-2">
    <div>
      <h1 class="h5 m-0">{{ actividad.titulo }}</h1>
      <div class="small text-muted">
        {{ actividad.get_dificultad_display }} · XP {{ actividad.xp_total }}
        {% if actividad.fecha_cierre %} · Cierra: {{ actividad.fecha_cierre|date:"d/m/Y H:i" }}{% endif %}
        · Intento {{ intento_actual }}/{{ intentos_max }}
      </div>
    </div>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'estudiante_lista' %}">Volver</a>
      <a class="btn btn-outline-primary btn-sm" href="{% url 'resolver' actividad.pk %}?modo=play">Jugar</a>
      <a class="btn btn-outline-success btn-sm" href="{% url 'resolver_resultado' actividad.pk %}">Resultados</a>
    </div>
  </div>

  <div class="card p-3">
    {% for item in actividad.items.all %}
      {% with tipo=item.tipo|lower datos=item.datos %}
      <div class="mb-4 p-3 border rounded">
        <div class="d-flex align-items-start justify-content-between">
          <h2 class="h6 m-0">{{ forloop.counter }}. {{ item.enunciado }}</h2>
          <span class="badge text-bg-light text-muted">Puntaje: {{ item.puntaje }}</span>
        </div>

        {% if item.imagen %}
          <img src="{{ item.imagen.url }}" class="img-fluid my-2" alt="Imagen del ítem">
        {% endif %}

        {# --------- INTERACTIVE (URL embebible) --------- #}
        {% if tipo == "interactive" %}
          {% if datos.url %}
            <div class="ratio ratio-16x9 my-2">
              <iframe src="{{ datos.url }}" allowfullscreen></iframe>
            </div>
          {% else %}
            <div class="alert alert-warning mt-2">No hay URL para embeber.</div>
          {% endif %}

        {# --------- GAME (minijuegos) --------- #}
        {% elif tipo == "game" %}
          {% if datos.url %}
            <div class="ratio ratio-16x9 my-2">
              <iframe src="{{ datos.url }}" allowfullscreen></iframe>
            </div>
          {% elif datos.kind %}
            {% with cfgid="gamecfg_"|add:item.pk %}
              {{ datos|json_script:cfgid }}
              <div class="game-host my-2"
                   data-actividad="{{ actividad.pk }}"
                   data-item="{{ item.pk }}"
                   data-kind="{{ datos.kind }}"
                   data-config-id="{{ cfgid }}">
                <div class="game-skeleton">Cargando minijuego…</div>
              </div>
            {% endwith %}
          {% else %}
            <div class="alert alert-warning mt-2">No hay configuración de juego.</div>
          {% endif %}

        {% else %}
          <div class="alert alert-secondary mt-2">Tipo no soportado: {{ tipo }}</div>
        {% endif %}
      </div>
      {% endwith %}
    {% empty %}
      <div class="alert alert-info">Esta actividad aún no tiene ítems.</div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
  <link rel="stylesheet" href="{% static 'LevelUp/css/games.css' %}">

  <div id="game-avatar-data"
       data-img="{% static 'LevelUp/img/avatars/otter.png' %}"
       data-nivel="{{ request.user.estudiante.nivel|default:1 }}"
       data-xp="{{ request.user.estudiante.xp|default:0 }}">
  </div>
  {{ avatar_equip|json_script:"game-avatar-equip" }}

  <script type="module" src="{% static 'LevelUp/js/games/bootstrap.js' %}"></script>
  <script type="module" src="{% static 'LevelUp/js/games/loader.js' %}"></script>
{% endblock %}