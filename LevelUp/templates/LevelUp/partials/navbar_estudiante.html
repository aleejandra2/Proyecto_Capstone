{% load static %}

<header class="acad-navbar seussbar topbar">
  <div class="container topbar-inner">

    <!-- IZQUIERDA: selector de asignatura -->
    <div class="topbar-left">
      <div class="subject-selector has-dropdown">

        <!-- Botón principal (asignatura actual) -->
        {% if asignaturas %}
        {% if request.session.asignatura_activa_icono and request.session.asignatura_activa_nombre %}
        {# Si hay algo en sesión, usarlo como actual #}
        <button type="button" class="subject-main">
          <span class="subject-icon">
            <img src="{% static request.session.asignatura_activa_icono %}" alt="" class="subject-main-img">
          </span>
          <span class="subject-name">
            {{ request.session.asignatura_activa_nombre }}
          </span>
          <i class="bi bi-caret-down-fill subject-caret"></i>
        </button>
        {% else %}
        {# Sin nada en sesión: usar la primera asignatura #}
        {% with asignaturas.0 as current_asig %}
        <button type="button" class="subject-main">
          <span class="subject-icon">
            <img src="{% static current_asig.icono %}" alt="" class="subject-main-img">
          </span>
          <span class="subject-name">
            {{ current_asig.nombre }}
          </span>
          <i class="bi bi-caret-down-fill subject-caret"></i>
        </button>
        {% endwith %}
        {% endif %}
        {% else %}
        <!-- Si no hay asignaturas, dejamos el texto por defecto -->
        <button type="button" class="subject-main">
          <span class="subject-icon">
            <i class="bi bi-calculator"></i>
          </span>
          <span class="subject-name">
            Selecciona una asignatura
          </span>
          <i class="bi bi-caret-down-fill subject-caret"></i>
        </button>
        {% endif %}

        <!-- Dropdown con todas las asignaturas -->
        <div class="subject-dropdown" role="menu" aria-label="Seleccionar asignatura">
          <ul class="subject-list">
            {% for asig in asignaturas %}
            {% with item_slug=asig.slug|default:asig.nombre|slugify %}
            <li>
              <a href="#"
                class="subject-item js-subject{% if request.session.asignatura_activa_slug == item_slug %} is-active{% endif %}"
                data-slug="{{ item_slug }}" data-name="{{ asig.nombre }}" data-icon="{% static asig.icono %}">
                <span class="subject-egg">
                  <img src="{% static asig.icono %}" alt="" class="egg-img">
                </span>
                <span class="subject-label">{{ asig.nombre }}</span>
              </a>
            </li>
            {% endwith %}
            {% empty %}
            <li class="subject-empty text-muted px-3 py-2">Sin asignaturas</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>

    <!-- CENTRO: SOLO RANGO -->
    <div class="topbar-center">
      <div class="status-pill">
        <div class="status-block">
          <span class="status-text">
            Rango: {{ perfil.rango_timo|default:"Timo Explorador" }}
          </span>
        </div>
      </div>
    </div>

    <!-- DERECHA: usuario -->
    <div class="topbar-right">
      <span class="topbar-divider"></span>

      <div class="dropdown user-dropdown">
        <button class="user-pill" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Menú de usuario">
          <span class="user-avatar">
            {{ request.user.first_name|default:request.user.username|first|upper }}
          </span>
          <span class="user-name d-none d-md-inline">
            {{ request.user.get_full_name|default:request.user.username }}
          </span>
          <i class="bi bi-caret-down-fill ms-1"></i>
        </button>

        <ul class="dropdown-menu dropdown-menu-end">
          <li><a class="dropdown-item" href="{% url 'perfil' %}"><i class="bi bi-person"></i> Mi perfil</a></li>
          <li><a class="dropdown-item" href="{% url 'recompensas' %}"><i class="bi bi-award"></i> Recompensas</a></li>
          <li>
            <hr class="dropdown-divider">
          </li>
          <li><a class="dropdown-item" href="{% url 'logout' %}"><i class="bi bi-box-arrow-right"></i> Cerrar sesión</a>
          </li>
        </ul>
      </div>
    </div>

  </div>
</header>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const subjectMain = document.querySelector(".subject-main");
    if (!subjectMain) return;

    const mainImg = subjectMain.querySelector(".subject-icon img.subject-main-img");
    const mainName = subjectMain.querySelector(".subject-name");
    const dropdown = document.querySelector(".subject-dropdown");
    const setAsigUrl = "{% url 'estudiante_set_asignatura' %}";
    const actividadesPath = "{% url 'estudiante_lista' %}";  // ruta Mis actividades

    // Abrir/cerrar dropdown
    subjectMain.addEventListener("click", function () {
      if (!dropdown) return;
      dropdown.classList.toggle("is-open");
    });

    // Cerrar dropdown al hacer click fuera
    document.addEventListener("click", function (e) {
      if (!dropdown) return;
      if (!e.target.closest(".subject-selector")) {
        dropdown.classList.remove("is-open");
      }
    });

    document.querySelectorAll(".subject-item.js-subject").forEach(function (item) {
      item.addEventListener("click", function (e) {
        e.preventDefault();

        const name = item.dataset.name;
        const icon = item.dataset.icon;
        const slug = item.dataset.slug;

        if (!slug) return;

        // Actualizar texto/icono del botón
        if (mainName && name) {
          mainName.textContent = name;
        }
        if (mainImg && icon) {
          mainImg.src = icon;
        }

        // Marcar activo
        document.querySelectorAll(".subject-item.js-subject.is-active")
          .forEach(el => el.classList.remove("is-active"));
        item.classList.add("is-active");

        // Guardar en sesión
        fetch(setAsigUrl + "?slug=" + encodeURIComponent(slug), {
          method: "GET",
          headers: { "X-Requested-With": "XMLHttpRequest" }
        })
          .then(resp => resp.json().then(data => ({ status: resp.status, data })))
          .then(({ status, data }) => {
            if (!data.ok) {
              console.error("No se pudo fijar la asignatura:", data.error || status);
              return;
            }

            console.log("Asignatura activa:", data.nombre);

            // Si estoy en "Mis actividades", recargo para aplicar filtro
            if (window.location.pathname === actividadesPath) {
              window.location.reload();
            }
          })
          .catch(err => {
            console.error("Error en la petición de asignatura:", err);
          });

        if (dropdown) {
          dropdown.classList.remove("is-open");
        }
      });
    });
  });
</script>