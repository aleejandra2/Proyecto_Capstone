(()=>{
  const root = document.getElementById('msGame');
  if (!root) return;

  // Construcción del suelo visual
  const cols = 12;
  const grid = document.createElement('div');
  grid.className = 'ms-grid';
  root.appendChild(grid);
  for (let i=0;i<cols;i++){
    const t = document.createElement('div'); t.className='ms-tile'; grid.appendChild(t);
  }

  // Estado del mundo (pixeles)
  let W = root.clientWidth;
  let H = root.clientHeight;
  const FLOOR_Y = H - 56; // altura del piso
  const AV_W = 32, AV_H = 32;
  const SPEED = 3.0, GRAV = 0.8, JUMP = -11;

  // Avatar
  const av = document.createElement('div'); av.className='ms-avatar'; av.style.left='0px'; av.style.top = (FLOOR_Y-AV_H)+'px'; root.appendChild(av);
  let x = 16, y = FLOOR_Y-AV_H, vx = 0, vy = 0; const keys = {};

  // Objetos (moneda y bloque pregunta)
  const coin = document.createElement('div'); coin.className='ms-coin'; root.appendChild(coin);
  const qblock = document.createElement('div'); qblock.className='ms-enemy'; root.appendChild(qblock);
  let coinPos = { x: Math.round(W*0.35), y: FLOOR_Y-18 };
  let qbPos   = { x: Math.round(W*0.65), y: FLOOR_Y-18 };
  position(coin, coinPos.x, coinPos.y); position(qblock, qbPos.x, qbPos.y);

  function position(el, px, py){ el.style.position='absolute'; el.style.left=px+'px'; el.style.top=py+'px'; }
  function place(){ av.style.left = Math.round(x)+'px'; av.style.top = Math.round(y)+'px'; }

  // Preguntas desde json_script
  let preguntas = [];
  try{ const el = document.getElementById('ms-questions'); if(el){ preguntas = JSON.parse(el.textContent||'[]'); } }catch{}
  const overlay = document.createElement('div');
  overlay.className = 'ms-q';
  overlay.innerHTML = '<div><div class="fw-bold mb-2" id="qText"></div><div id="qOpts"></div></div>';
  root.appendChild(overlay);
  function ask(){
    if (!preguntas.length) return;
    const p = preguntas[0];
    document.getElementById('qText').textContent = p.q;
    const box = document.getElementById('qOpts'); box.innerHTML='';
    p.opts.forEach((o,i)=>{
      const b = document.createElement('button'); b.className='btn btn-sm btn-outline-primary me-2 mb-2'; b.textContent=o;
      b.onclick = ()=>{
        if (i===p.ans){ award(); overlay.style.display='none'; preguntas.shift(); }
        else { b.classList.replace('btn-outline-primary','btn-danger'); }
      };
      box.appendChild(b);
    });
    overlay.style.display='flex';
  }

  function award(){
    const key='ms_'+(document.title||'world')+'_progress';
    const cur=parseInt(localStorage.getItem(key)||'0',10)||0;
    const nxt=Math.min(100,cur+25);
    localStorage.setItem(key,String(nxt));
  }

  // Input
  window.addEventListener('keydown',e=>{ keys[e.key.toLowerCase()] = true; });
  window.addEventListener('keyup',e=>{ keys[e.key.toLowerCase()] = false; });

  function loop(){
    // Horizontal
    vx = 0;
    if (keys['arrowright']||keys['d']) vx = SPEED;
    if (keys['arrowleft']||keys['a'])  vx = -SPEED;

    // Salto
    if ((keys['arrowup']||keys['w']||keys[' ']) && Math.abs((y+AV_H)-FLOOR_Y)<1) vy = JUMP;

    // Física simple
    vy += GRAV; y += vy; x += vx;
    // Colisiones con suelo y bordes
    if (y+AV_H >= FLOOR_Y){ y = FLOOR_Y-AV_H; vy = 0; }
    if (x < 0) x = 0; if (x+AV_W > W) x = W-AV_W;
    place();

    // Moneda
    if (hit(x,y,AV_W,AV_H, coinPos.x, coinPos.y, 16,16)) coin.remove();
    // Bloque pregunta
    if (hit(x,y,AV_W,AV_H, qbPos.x, qbPos.y, 18,18)) ask();

    requestAnimationFrame(loop);
  }
  function hit(ax,ay,aw,ah,bx,by,bw,bh){ return ax < bx+bw && ax+aw > bx && ay < by+bh && ay+ah > by; }

  // Ajuste responsive
  function resize(){ W = root.clientWidth; H = root.clientHeight; }
  window.addEventListener('resize', resize);
  resize(); place(); requestAnimationFrame(loop);
})();
